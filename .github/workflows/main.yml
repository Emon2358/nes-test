name: NSDLib — Build MML to NSF (interactive input version)

on:
  workflow_dispatch:
    inputs:
      nsdl_version:
        description: "NSDLib version (例: v1.30)"
        required: true
        default: "v1.30"
      opt_version:
        description: "NSF version option (-v)"
        required: true
        default: "-v 2"
      opt_ext:
        description: "Enable NSFe / extended NSF (-x)"
        required: true
        default: "-x"
      opt_defines:
        description: "Macro definitions (-D)"
        required: false
        default: ""
      opt_include:
        description: "Include directory (-I)"
        required: false
        default: ""
      opt_meta:
        description: "Metadata file (-M)"
        required: false
        default: ""
      mml_dir:
        description: "Directory containing .mml files"
        required: true
        default: "mml"
      output_dir:
        description: "Output directory for NSF files"
        required: true
        default: "output"

jobs:
  build-nsdlib:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download NSDLib
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.nsdl_version }}"
        $zipUrl = "https://github.com/Shaw02/nsdlib/releases/download/$version/nsdl130.zip"
        $out = "nsdl.zip"
        Write-Host "Downloading NSDLib $version from $zipUrl ..."
        Invoke-WebRequest -Uri $zipUrl -OutFile $out -UseBasicParsing
        Expand-Archive -Path $out -DestinationPath nsdl130 -Force
        Write-Host "NSDLib extracted."

    - name: Prepare workspace
      shell: pwsh
      run: |
        if (!(Test-Path "nsdl130/bin/nsd.bin")) {
          Write-Error "Driver file nsd.bin not found."
          exit 1
        }
        $outDir = "${{ github.event.inputs.output_dir }}"
        if (!(Test-Path $outDir)) { New-Item -Path $outDir -ItemType Directory }
        Write-Host "Workspace ready."

    - name: Compile all MML to NSF
      shell: pwsh
      run: |
        $compiler = Join-Path $PWD "nsdl130/bin/nsc64.exe"
        if (!(Test-Path $compiler)) {
          Write-Error "Compiler not found: $compiler"
          exit 1
        }

        $driver = Join-Path $PWD "nsdl130/bin/nsd.bin"
        $mmlDir = "${{ github.event.inputs.mml_dir }}"
        $outDir = "${{ github.event.inputs.output_dir }}"

        $optVersion = "${{ github.event.inputs.opt_version }}"
        $optExt = "${{ github.event.inputs.opt_ext }}"
        $optDefines = "${{ github.event.inputs.opt_defines }}"
        $optInclude = "${{ github.event.inputs.opt_include }}"
        $optMeta = "${{ github.event.inputs.opt_meta }}"

        $mmlFiles = Get-ChildItem -Path $mmlDir -Filter *.mml -Recurse
        if ($mmlFiles.Count -eq 0) {
          Write-Error "No .mml files found in $mmlDir"
          exit 1
        }

        foreach ($file in $mmlFiles) {
          $base = $file.BaseName
          $outFile = Join-Path $PWD "$outDir\$base.nsf"
          Write-Host "Compiling: $($file.FullName) → $outFile"

          & $compiler `
            -L $driver `
            $optVersion `
            $optExt `
            $optDefines `
            $optInclude `
            $optMeta `
            $file.FullName `
            -o $outFile

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Compilation failed for $($file.FullName)"
            exit 1
          }
        }

        Write-Host "All MML compiled successfully."

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nsdlib-output
        path: |
          ${{ github.event.inputs.output_dir }}/
          nsdl130/

    - name: Workflow completed
      shell: pwsh
      run: Write-Host "✅ Build completed successfully."
